<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hangout BETA</title>
  <style>
    :root {
      --bg: #0b0c10;
      --sidebar: #0d0e11;
      --text: #e0e0e0;
      --accent: #5865f2;
      --green: #3ba55c;
      --red: #ed4245;
      --shadow: 0 4px 20px rgba(0,0,0,0.7);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: radial-gradient(circle at 10% 20%, #0b0c10 0%, #0f1014 50%, #0b0c10 100%);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 70%, rgba(88,101,242,0.08) 0%, transparent 40%),
                  radial-gradient(circle at 80% 30%, rgba(59,165,92,0.06) 0%, transparent 40%),
                  radial-gradient(circle at 20% 90%, rgba(237,66,69,0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    #sidebar {
      width: 240px;
      background: var(--sidebar);
      padding: 12px;
      border-right: 1px solid #0a0b0e;
      overflow-y: auto;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #video-area {
      flex: 1;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .video-tile {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      background: black;
      position: relative;
      transition: all 0.4s ease;
    }
    #remote-tile {
      width: 480px;
      height: 360px;
      max-width: 90%;
      max-height: 70vh;
    }
    #local-tile {
      position: absolute;
      bottom: 100px;
      right: 20px;
      width: 180px;
      height: 135px;
      border: 3px solid var(--accent);
      z-index: 20;
    }
    .side-by-side #remote-tile,
    .side-by-side #local-tile {
      position: static;
      width: 45%;
      height: 60vh;
      max-width: 600px;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000; /* Fallback in case video is black */
    }
    .avatar-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(6px);
    }
    .avatar-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      font-size: 5.5rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      box-shadow: 0 6px 25px rgba(0,0,0,0.6);
    }
    #local-tile .avatar-circle {
      width: 80px;
      height: 80px;
      font-size: 3rem;
    }
    #bottom-bar {
      height: 80px;
      background: rgba(13,14,17,0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid #0a0b0e;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      z-index: 30;
    }
    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 1.6rem;
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    .control-btn:hover { transform: scale(1.15); }
    .cam-on { background: var(--green); }
    .mute-on { background: var(--red); }
    .hangup { background: var(--red); }
    #incoming, #tutorial-modal, #snake-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      place-items: center;
      z-index: 1000;
    }
    .modal-box {
      background: #15181d;
      padding: 40px;
      border-radius: 16px;
      text-align: center;
      width: 380px;
      max-width: 90%;
      box-shadow: var(--shadow);
    }
    #game-area {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 50;
    }
    #game-info {
      color: white;
      font-size: 1.4rem;
    }
    canvas {
      background: #111;
      border: 4px solid var(--accent);
      border-radius: 12px;
    }
  </style>
</head>
<body>

<div id="sidebar">
  <h2 style="margin-bottom:20px;">Hangout BETA by ooze</h2>
  <div style="margin-bottom:20px;">
    <input type="text" id="username" placeholder="Your Name" style="width:100%; padding:12px; border-radius:8px; border:none; background:#1e2128; color:white;">
    <button onclick="saveName()" style="margin-top:10px; width:100%; padding:12px; border-radius:8px; background:var(--accent); color:white; border:none;">Save</button>
  </div>
  <div style="margin-bottom:20px;">
    <input type="text" id="callTarget" placeholder="Friend's Peer ID" style="width:100%; padding:12px; border-radius:8px; border:none; background:#1e2128; color:white;">
    <button onclick="startPrivateCall()" style="margin-top:10px; width:100%; padding:12px; border-radius:8px; background:var(--green); color:white; border:none;">Call</button>
  </div>
  <div style="margin:20px 0; font-size:0.95rem;">
    Your ID: <strong id="myId">---</strong>
  </div>
  <button onclick="showTutorial()" style="width:100%; padding:12px; border-radius:8px; background:var(--accent); color:white; border:none;">Tutorial</button>
</div>

<div id="main">
  <div id="video-area">
    <div id="remote-tile" class="video-tile">
      <video id="remote-video" autoplay playsinline></video>
      <div id="remote-avatar" class="avatar-placeholder">
        <div class="avatar-circle" id="remote-letter">?</div>
      </div>
    </div>

    <div id="local-tile" class="video-tile">
      <video id="local-video" autoplay playsinline muted></video>
      <div id="local-avatar" class="avatar-placeholder">
        <div class="avatar-circle" id="local-letter">?</div>
      </div>
    </div>
  </div>

  <div id="bottom-bar">
    <button id="muteBtn" class="control-btn" onclick="toggleMute()">ğŸ”‡</button>
    <button id="camBtn" class="control-btn cam-on" onclick="toggleCamera()">ğŸ“·</button>
    <button id="snakeBtn" class="control-btn" onclick="requestSnakeGame()">ğŸ</button>
    <button class="control-btn hangup" onclick="hangUp()">ğŸ“</button>
  </div>
</div>

<!-- Game Overlay -->
<div id="game-area">
  <div id="game-info">Level <span id="level">1</span> â€¢ Score: <span id="score">0</span></div>
  <canvas id="snake-canvas" width="600" height="600"></canvas>
  <button style="padding:12px 30px; background:var(--red); color:white; border:none; border-radius:8px; font-size:1.2rem;" onclick="endSnakeGame()">Exit Game</button>
</div>

<!-- Incoming Call -->
<div id="incoming">
  <div class="modal-box">
    <h2>Incoming Call</h2>
    <p id="callerName" style="font-size:1.5rem; margin:25px 0;">...</p>
    <div style="display:flex; gap:30px; justify-content:center;">
      <button style="background:var(--green); color:white; padding:14px 50px; border:none; border-radius:10px;" onclick="acceptCall()">Accept</button>
      <button style="background:var(--red); color:white; padding:14px 50px; border:none; border-radius:10px;" onclick="declineCall()">Decline</button>
    </div>
  </div>
</div>

<!-- Tutorial -->
<div id="tutorial-modal">
  <div class="modal-box" style="width:520px; text-align:left;">
    <h2>Tutorial</h2>
    <ul style="margin:25px 0; padding-left:24px;">
      <li>Enter & save your name</li>
      <li>Share your Peer ID</li>
      <li>Call your friend</li>
      <li>Both cameras on â†’ side-by-side big videos</li>
      <li>One camera â†’ big main + small self-view</li>
      <li>Click ğŸ to request multiplayer snake (with levels!)</li>
    </ul>
    <button style="background:var(--accent); color:white; padding:14px; border:none; border-radius:10px; width:100%;" onclick="hideTutorial()">Close</button>
  </div>
</div>

<!-- Snake Request -->
<div id="snake-modal">
  <div class="modal-box">
    <h2>Snake Game</h2>
    <p id="snakeRequester" style="font-size:1.4rem; margin:20px 0;">wants to play snake</p>
    <div style="display:flex; gap:30px; justify-content:center;">
      <button style="background:var(--green); color:white; padding:14px 40px; border:none; border-radius:10px;" onclick="acceptSnake()">Play</button>
      <button style="background:var(--red); color:white; padding:14px 40px; border:none; border-radius:10px;" onclick="declineSnake()">Cancel</button>
    </div>
  </div>
</div>

<audio id="ringtone" loop preload="auto"></audio>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STUN = [{ urls: 'stun:stun.l.google.com:19302' }];
let peer, localStream = null, currentIncoming = null, dataConn = null, currentCall = null;
let myName = localStorage.getItem('vcName') || 'Fortnite';
let myId = localStorage.getItem('vcId');
let remoteName = '';
let isCameraOn = true;
let remoteCameraOn = false;
let snakeGame = null;
let currentSnakeRequest = null;

document.getElementById('username').value = myName;
const ringtone = document.getElementById('ringtone');
ringtone.src = 'https://assets.codepen.io/438780/discord-incoming-call-short.mp3';

const remoteVid = document.getElementById('remote-video');
const localVid = document.getElementById('local-video');
const localLetter = document.getElementById('local-letter');
const remoteLetter = document.getElementById('remote-letter');

// â”€â”€ INIT PEER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPeer() {
  const opts = { config: { iceServers: STUN }, debug: 2 };
  if (myId) opts.id = myId;
  peer = new Peer(opts);

  peer.on('open', id => {
    if (!myId) {
      myId = id;
      localStorage.setItem('vcId', id);
    }
    document.getElementById('myId').textContent = id;
    updateAvatars();
  });

  peer.on('call', call => {
    currentIncoming = call;
    document.getElementById('callerName').textContent = call.metadata?.name || call.peer.slice(0,8);
    document.getElementById('incoming').style.display = 'flex';
    ringtone.play().catch(()=>{});
  });

  peer.on('connection', conn => {
    dataConn = conn;
    setupDataConn(conn);
  });
}

// â”€â”€ DATA CONNECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupDataConn(conn) {
  conn.on('data', data => {
    if (data.type === 'name') {
      remoteName = data.name;
      updateAvatars();
    } else if (data.type === 'camera') {
      remoteCameraOn = data.on;
      updateLayout();
    } else if (data.type === 'snakeRequest') {
      currentSnakeRequest = conn;
      document.getElementById('snakeRequester').textContent = `${data.name} wants to play snake`;
      document.getElementById('snake-modal').style.display = 'flex';
    } else if (data.type === 'snakeAccept') {
      startSnakeGame();
    } else if (data.type === 'snakeDecline') {
      alert(`${remoteName} declined the snake game.`);
    } else if (data.type === 'snakeMove') {
      if (snakeGame) snakeGame.opponentMove(data.dir);
    }
  });
}

// â”€â”€ LAYOUT & AVATARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateAvatars() {
  localLetter.textContent = myName.charAt(0).toUpperCase() || '?';
  remoteLetter.textContent = remoteName.charAt(0).toUpperCase() || '?';
  updateLayout();
}

function updateLayout() {
  const videoArea = document.getElementById('video-area');
  const bothOn = isCameraOn && remoteCameraOn;

  if (bothOn) {
    videoArea.classList.add('side-by-side');
  } else {
    videoArea.classList.remove('side-by-side');
  }

  const localHasVideo = localStream && localStream.getVideoTracks().length > 0 && localStream.getVideoTracks()[0].enabled;
  localVid.style.display = (isCameraOn && localHasVideo) ? 'block' : 'none';
  document.getElementById('local-avatar').style.display = (isCameraOn && localHasVideo) ? 'none' : 'flex';

  const remoteHasVideo = remoteVid.srcObject && remoteVid.srcObject.getVideoTracks().length > 0 && remoteVid.srcObject.getVideoTracks()[0].enabled;
  remoteVid.style.display = (remoteCameraOn && remoteHasVideo) ? 'block' : 'none';
  document.getElementById('remote-avatar').style.display = (remoteCameraOn && remoteHasVideo) ? 'none' : 'flex';
}

// â”€â”€ CALLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function acceptCall() {
  if (!currentIncoming) return;
  try {
    if (!localStream) {
      localStream = await navigator.mediaDevices.getUserMedia({ 
        audio: true, 
        video: { 
          width: { ideal: 1280 },
          height: { ideal: 720 },
          facingMode: "user"
        } 
      });
    }
    currentIncoming.answer(localStream);
    setupCall(currentIncoming);

    const conn = peer.connect(currentIncoming.peer);
    dataConn = conn;
    setupDataConn(conn);
    conn.on('open', () => sendMyInfo());
  } catch (e) {
    console.error("Camera access error:", e);
    alert("Could not access camera. Check permissions.");
  }
  document.getElementById('incoming').style.display = 'none';
  ringtone.pause();
  currentIncoming = null;
}

function setupCall(call) {
  currentCall = call;
  call.on('stream', stream => {
    remoteVid.srcObject = stream;
    remoteCameraOn = stream.getVideoTracks().length > 0 && stream.getVideoTracks()[0].enabled;
    updateLayout();
  });
  call.on('close', () => hangUp());
}

async function startPrivateCall() {
  const target = document.getElementById('callTarget').value.trim();
  if (!target) return alert('Enter Peer ID');

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ 
      audio: true, 
      video: { 
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: "user"
      } 
    });
    updateLayout();

    const call = peer.call(target, localStream, { metadata: { name: myName } });
    setupCall(call);

    const conn = peer.connect(target);
    dataConn = conn;
    setupDataConn(conn);
    conn.on('open', () => sendMyInfo());
  } catch (e) {
    console.error("Call failed / camera error:", e);
    alert("Could not start call - camera access denied or failed.");
  }
}

function sendMyInfo() {
  if (dataConn) {
    dataConn.send({ type: 'name', name: myName });
    dataConn.send({ type: 'camera', on: isCameraOn });
  }
}

async function toggleCamera() {
  isCameraOn = !isCameraOn;
  
  if (isCameraOn) {
    try {
      // Try to get camera again if we don't have it
      if (!localStream || localStream.getVideoTracks().length === 0) {
        const camStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "user"
          } 
        });
        if (localStream) {
          localStream.addTrack(camStream.getVideoTracks()[0]);
        } else {
          localStream = camStream;
        }
      } else {
        localStream.getVideoTracks().forEach(t => t.enabled = true);
      }
    } catch (e) {
      console.error("Camera re-enable failed:", e);
      alert("Couldn't turn camera back on - check permissions");
      isCameraOn = false; // revert if failed
    }
  } else {
    // Just disable tracks instead of stopping them (so we can re-enable)
    if (localStream) {
      localStream.getVideoTracks().forEach(t => t.enabled = false);
    }
  }

  updateLayout();
  if (dataConn) dataConn.send({ type: 'camera', on: isCameraOn });
  document.getElementById('camBtn').classList.toggle('cam-on', isCameraOn);
}

function toggleMute() {
  if (localStream) localStream.getAudioTracks().forEach(t => t.enabled = !t.enabled);
  document.getElementById('muteBtn').classList.toggle('mute-on');
}

function hangUp() {
  currentCall?.close();
  dataConn?.close();
  localStream?.getTracks().forEach(t => t.stop());
  localStream = null;
  remoteVid.srcObject = null;
  remoteName = '';
  remoteCameraOn = false;
  endSnakeGame();
  updateLayout();
}

function saveName() {
  myName = document.getElementById('username').value.trim() || 'Fortnite';
  localStorage.setItem('vcName', myName);
  updateAvatars();
  if (dataConn) dataConn.send({ type: 'name', name: myName });
}

// â”€â”€ SNAKE GAME (unchanged from previous working version) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requestSnakeGame() {
  if (!dataConn) return alert('Not in a call');
  dataConn.send({ type: 'snakeRequest', name: myName });
}

function acceptSnake() {
  document.getElementById('snake-modal').style.display = 'none';
  if (currentSnakeRequest) {
    currentSnakeRequest.send({ type: 'snakeAccept' });
    startSnakeGame();
  }
}

function declineSnake() {
  document.getElementById('snake-modal').style.display = 'none';
  if (currentSnakeRequest) currentSnakeRequest.send({ type: 'snakeDecline' });
}

function startSnakeGame() {
  document.getElementById('game-area').style.display = 'flex';
  snakeGame = new MultiplayerSnake();
}

function endSnakeGame() {
  document.getElementById('game-area').style.display = 'none';
  if (snakeGame) clearInterval(snakeGame.loop);
  snakeGame = null;
}

class MultiplayerSnake {
  constructor() {
    this.canvas = document.getElementById('snake-canvas');
    this.ctx = this.canvas.getContext('2d');
    this.grid = 20;
    this.size = this.canvas.width / this.grid;

    this.level = 1;
    this.score = 0;
    this.speed = 150;

    this.player = [{x: 5, y: 10}];
    this.opponent = [{x: 25, y: 10}];
    this.playerDir = 'right';
    this.opponentDir = 'left';
    this.food = this.randomFood();

    document.getElementById('level').textContent = this.level;
    document.getElementById('score').textContent = this.score;

    this.setupControls();
    this.loop = setInterval(() => this.update(), this.speed);
  }

  setupControls() {
    document.onkeydown = e => {
      let dir;
      if (e.key === 'w' && this.playerDir !== 'down') dir = 'up';
      if (e.key === 's' && this.playerDir !== 'up') dir = 'down';
      if (e.key === 'a' && this.playerDir !== 'right') dir = 'left';
      if (e.key === 'd' && this.playerDir !== 'left') dir = 'right';
      if (dir) {
        this.playerDir = dir;
        if (dataConn) dataConn.send({ type: 'snakeMove', dir });
      }
    };
  }

  opponentMove(dir) {
    this.opponentDir = dir;
  }

  update() {
    this.move(this.player, this.playerDir);
    this.move(this.opponent, this.opponentDir);

    if (this.eat(this.player)) this.score += 10;
    if (this.eat(this.opponent)) this.score += 5;

    if (this.score > 0 && this.score % 50 === 0) this.levelUp();

    this.checkCollision();
    this.draw();
  }

  move(snake, dir) {
    const head = {x: snake[0].x, y: snake[0].y};
    if (dir === 'up') head.y--;
    if (dir === 'down') head.y++;
    if (dir === 'left') head.x--;
    if (dir === 'right') head.x++;
    snake.unshift(head);
    snake.pop();
  }

  eat(snake) {
    const head = snake[0];
    if (head.x === this.food.x && head.y === this.food.y) {
      snake.push({...snake[snake.length-1]});
      this.food = this.randomFood();
      document.getElementById('score').textContent = this.score += 10;
      return true;
    }
    return false;
  }

  levelUp() {
    this.level++;
    this.speed = Math.max(50, this.speed - 20);
    clearInterval(this.loop);
    this.loop = setInterval(() => this.update(), this.speed);
    document.getElementById('level').textContent = this.level;
  }

  checkCollision() {
    const p = this.player[0];
    const o = this.opponent[0];
    if (p.x < 0 || p.x >= this.size || p.y < 0 || p.y >= this.size ||
        o.x < 0 || o.x >= this.size || o.y < 0 || o.y >= this.size) {
      alert('Game Over! Final Score: ' + this.score);
      endSnakeGame();
    }
  }

  draw() {
    this.ctx.fillStyle = '#111';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

    this.ctx.fillStyle = '#3ba55c';
    this.player.forEach(s => this.ctx.fillRect(s.x * this.grid, s.y * this.grid, this.grid-2, this.grid-2));

    this.ctx.fillStyle = '#5865f2';
    this.opponent.forEach(s => this.ctx.fillRect(s.x * this.grid, s.y * this.grid, this.grid-2, this.grid-2));

    this.ctx.fillStyle = '#ed4245';
    this.ctx.fillRect(this.food.x * this.grid, this.food.y * this.grid, this.grid-2, this.grid-2);
  }

  randomFood() {
    return {
      x: Math.floor(Math.random() * this.size),
      y: Math.floor(Math.random() * this.size)
    };
  }
}

// â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTutorial() { document.getElementById('tutorial-modal').style.display = 'flex'; }
function hideTutorial() { document.getElementById('tutorial-modal').style.display = 'none'; }

// Init
initPeer();
updateAvatars();
</script>
</body>
</html>
