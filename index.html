<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hangout BETA (No Games)</title>
  <style>
    :root {
      --bg: #0b0c10;
      --sidebar: #0d0e11;
      --text: #e0e0e0;
      --accent: #5865f2;
      --green: #3ba55c;
      --red: #ed4245;
      --shadow: 0 4px 20px rgba(0,0,0,0.7);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: radial-gradient(circle at 10% 20%, #0b0c10 0%, #0f1014 50%, #0b0c10 100%);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 260px;
      background: var(--sidebar);
      padding: 16px;
      border-right: 1px solid #0a0b0e;
      overflow-y: auto;
    }
    #main { flex:1; display:flex; flex-direction:column; }
    #video-area {
      flex:1;
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
      gap:16px;
      flex-wrap:wrap;
      overflow:auto;
    }
    .video-tile {
      border-radius:12px;
      overflow:hidden;
      box-shadow:var(--shadow);
      background:#000;
      position:relative;
      transition:all 0.3s;
    }
    .main-video { width:520px; height:390px; max-width:90vw; max-height:65vh; }
    .self-video {
      position:absolute;
      bottom:30px; right:30px;
      width:200px; height:150px;
      border:3px solid var(--accent);
      z-index:20;
    }
    video {
      width:100%; height:100%;
      object-fit:cover;
      background:#000;
    }
    .avatar-placeholder {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(6px);
    }
    .avatar-circle {
      width:110px; height:110px;
      border-radius:50%;
      background:var(--accent);
      color:white;
      font-size:4.2rem;
      font-weight:bold;
      display:flex; align-items:center; justify-content:center;
      text-transform:uppercase;
    }
    #bottom-bar {
      height:80px;
      background:rgba(13,14,17,0.94);
      backdrop-filter:blur(12px);
      border-top:1px solid #0a0b0e;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:28px;
      z-index:30;
    }
    .control-btn {
      width:58px; height:58px;
      border-radius:50%;
      border:none;
      font-size:1.6rem;
      cursor:pointer;
      transition: all 0.22s;
      box-shadow:0 3px 12px rgba(0,0,0,0.5);
    }
    .control-btn:hover { transform:scale(1.14); }
    .cam-on { background:var(--green); }
    .mute-on { background:var(--red); }
    .hangup { background:var(--red); }
    #incoming, #tutorial-modal {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.92);
      display:none;
      place-items:center;
      z-index:1000;
    }
    .modal-box {
      background:#15181d;
      padding:36px;
      border-radius:16px;
      text-align:center;
      width:420px;
      max-width:92%;
      box-shadow:var(--shadow);
    }
  </style>
</head>
<body>
<div id="sidebar">
  <h2 style="margin-bottom:24px;">Hangout BETA</h2>
  <div style="margin-bottom:24px;">
    <input type="text" id="username" placeholder="Your Name" style="width:100%;padding:12px;border-radius:8px;border:none;background:#1e2128;color:white;">
    <button onclick="saveName()" style="margin-top:10px;width:100%;padding:12px;border-radius:8px;background:var(--accent);color:white;border:none;">Save Name</button>
  </div>
  <div style="margin-bottom:20px;">
    <input type="text" id="callTarget" placeholder="Friend's Peer ID" style="width:100%;padding:12px;border-radius:8px;border:none;background:#1e2128;color:white;">
    <button onclick="startCall()" style="margin-top:10px;width:100%;padding:12px;border-radius:8px;background:var(--green);color:white;border:none;">Call</button>
  </div>
  <div style="margin:18px 0;font-size:0.95rem;">
    Your ID: <strong id="myId">---</strong>
  </div>

  <!-- Share ID Button -->
  <div style="margin: 24px 0;">
    <a href="https://padlet.com/O0ZE34/id-sharing-jfwe0dpoc856zkr6"
       target="_blank"
       rel="noopener noreferrer"
       style="display:block; width:100%; padding:14px;
              background:#5865f2; color:white;
              border:none; border-radius:10px;
              font-size:1.1rem; font-weight:600;
              text-align:center; text-decoration:none;
              box-shadow:0 3px 12px rgba(88,101,242,0.35);
              transition:all 0.22s;">
      Share your ID with friends! ðŸš€
    </a>
  </div>

  <div style="margin:25px 0;padding:14px;background:#1a1e25;border-radius:10px;">
    <h3 style="margin-bottom:14px;">Groups</h3>
    <div id="groupCreateSection">
      <button onclick="createGroup()" style="width:100%;padding:10px;background:#f04747;color:white;border:none;border-radius:8px;">Create Group</button>
    </div>
    <div id="groupJoinSection" style="margin-top:10px;">
      <input type="text" id="groupHostId" placeholder="Host's Peer ID" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none;background:#222;color:white;">
      <input type="text" id="groupCodeInput" placeholder="Group Code" style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:none;background:#222;color:white;">
      <button onclick="joinGroup()" style="width:100%;padding:10px;background:var(--green);color:white;border:none;border-radius:8px;">Join Group</button>
    </div>
    <div id="groupStatus" style="margin-top:14px;font-size:0.9rem;min-height:120px;word-break:break-all;"></div>
  </div>

  <button onclick="document.getElementById('tutorial-modal').style.display='flex'" 
          style="width:100%;padding:12px;border-radius:8px;background:var(--accent);color:white;border:none;margin-top:12px;">
    Tutorial
  </button>

  <!-- VERSION 2 BUTTON -->
  <button 
    onclick="window.open('https://oozehangoutsystempart22.global.ssl.fastly.net', '_blank')"
    style="
      width:100%;
      padding:14px;
      margin-top:16px;
      border-radius:10px;
      background: linear-gradient(135deg, #7289da, #5865f2);
      color:white;
      border:none;
      font-size:1.05rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 4px 14px rgba(88,101,242,0.4);
      transition: all 0.25s;
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(88,101,242,0.55)'"
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(88,101,242,0.4)'"
  >
    Version 2 â†’ Try it now!
  </button>

</div>

<div id="main">
  <div id="video-area">
    <div id="local-tile" class="video-tile self-video">
      <video id="local-video" autoplay playsinline muted></video>
      <div id="local-avatar" class="avatar-placeholder">
        <div class="avatar-circle" id="local-letter">?</div>
      </div>
    </div>
  </div>
  <div id="bottom-bar">
    <button id="muteBtn" class="control-btn" onclick="toggleMute()">ðŸ”‡</button>
    <button id="camBtn" class="control-btn cam-on" onclick="toggleCamera()">ðŸ“·</button>
    <button class="control-btn hangup" onclick="hangUpAll()">ðŸ“ž</button>
  </div>
</div>

<!-- Incoming Call Modal -->
<div id="incoming">
  <div class="modal-box">
    <h2>Incoming Call</h2>
    <p id="callerName" style="font-size:1.7rem;margin:28px 0;">...</p>
    <div style="display:flex;gap:50px;justify-content:center;">
      <button style="background:var(--green);color:white;padding:16px 70px;border:none;border-radius:10px;font-size:1.25rem;" onclick="acceptCall()">Accept</button>
      <button style="background:var(--red);color:white;padding:16px 70px;border:none;border-radius:10px;font-size:1.25rem;" onclick="declineCall()">Decline</button>
    </div>
  </div>
</div>

<!-- Tutorial Modal -->
<div id="tutorial-modal">
  <div class="modal-box" style="width:580px;text-align:left;line-height:1.5;">
    <h2>Tutorial</h2>
    <ul style="margin:28px 0;padding-left:28px;">
      <li>Save your display name</li>
      <li>Share your Peer ID</li>
      <li>Call your friend using their Peer ID</li>
      <li>Create group â†’ share your ID + code</li>
      <li>Join by entering host ID + code</li>
    </ul>
    <button style="background:var(--accent);color:white;padding:14px;border:none;border-radius:10px;width:100%;font-size:1.1rem;" onclick="document.getElementById('tutorial-modal').style.display='none'">Got it!</button>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let peer, localStream = null;
let myName = localStorage.getItem('vcName') || 'Player';
let dataConns = new Map();
let remoteStreams = new Map();
let remoteNames = new Map();
let remoteCameras = new Map();
let isCameraOn = true;
let groupCode = null;
let isGroupHost = false;
let groupMembers = new Map(); // id â†’ name
let currentCall = null;

// â”€â”€ PeerJS Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initPeer() {
  peer = new Peer({
    config: { iceServers: [{urls: 'stun:stun.l.google.com:19302'}] },
    debug: 2
  });
  peer.on('open', id => {
    document.getElementById('myId').textContent = id;
    updateLocalAvatar();
  });
  peer.on('call', call => {
    document.getElementById('callerName').textContent = call.metadata?.name || call.peer.slice(0,8);
    document.getElementById('incoming').style.display = 'flex';
    currentCall = call;
  });
  peer.on('connection', conn => setupDataConnection(conn));
}

function setupDataConnection(conn) {
  const pid = conn.peer;
  dataConns.set(pid, conn);
  conn.on('open', () => sendMyInfo(conn));
  conn.on('data', data => handleIncomingData(pid, data));
  conn.on('close', () => cleanupPeer(pid));
}

function sendMyInfo(conn) {
  conn.send({type:'name', name:myName});
  conn.send({type:'camera', on:isCameraOn});
}

function handleIncomingData(from, data) {
  if (data.type === 'name') {
    remoteNames.set(from, data.name);
    updateRemoteAvatar(from);
    if (groupMembers.has(from)) groupMembers.set(from, data.name);
    updateGroupDisplay();
  }
  else if (data.type === 'camera') {
    remoteCameras.set(from, data.on);
    updateVideoTile(from);
  }
  // â”€â”€ Group handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  else if (data.type === 'groupJoinRequest') {
    if (isGroupHost && data.code === groupCode) {
      groupMembers.set(from, remoteNames.get(from) || 'Unknown');
      dataConns.get(from)?.send({
        type: 'groupAccept',
        members: Array.from(groupMembers.entries()).map(([id,name])=>({id,name}))
      });
      broadcastToGroup({
        type: 'groupUpdate',
        members: Array.from(groupMembers.entries()).map(([id,name])=>({id,name}))
      }, from);
      updateGroupDisplay();
    } else {
      dataConns.get(from)?.send({type: 'groupReject'});
    }
  }
  else if (data.type === 'groupAccept') {
    data.members.forEach(m => groupMembers.set(m.id, m.name));
    connectToGroupMembers(data.members.filter(m => m.id !== peer.id));
    updateGroupDisplay();
  }
  else if (data.type === 'groupUpdate') {
    data.members.forEach(m => groupMembers.set(m.id, m.name));
    connectToGroupMembers(data.members.filter(m => m.id !== peer.id && !dataConns.has(m.id)));
    updateGroupDisplay();
  }
  else if (data.type === 'groupReject') {
    alert('Group join rejected: Invalid code or not host.');
  }
}

function cleanupPeer(pid) {
  dataConns.delete(pid);
  removeRemoteVideo(pid);
  if (groupMembers.has(pid)) {
    groupMembers.delete(pid);
    if (isGroupHost) broadcastToGroup({
      type: 'groupUpdate',
      members: Array.from(groupMembers.entries()).map(([id,name])=>({id,name}))
    });
  }
  updateGroupDisplay();
}

// â”€â”€ Media & Call Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startLocalMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user", width: {ideal:1280}, height: {ideal:720} },
    audio: true
  });
  localVid.srcObject = localStream;
  updateVideoTile();
}

async function startCall() {
  const target = document.getElementById('callTarget').value.trim();
  if (!target) return;
  if (!localStream) await startLocalMedia().catch(() => {});
  const call = peer.call(target, localStream, {metadata:{name:myName}});
  currentCall = call;
  setupCall(call);
  const conn = peer.connect(target);
  setupDataConnection(conn);
}

function setupCall(call) {
  call.on('stream', stream => addRemoteVideo(call.peer, stream));
  call.on('close', () => cleanupPeer(call.peer));
}

async function acceptCall() {
  if (!currentCall) return;
  if (!localStream) await startLocalMedia();
  currentCall.answer(localStream);
  setupCall(currentCall);
  const conn = peer.connect(currentCall.peer);
  setupDataConnection(conn);
  document.getElementById('incoming').style.display = 'none';
  currentCall = null;
}

function declineCall() {
  currentCall?.close();
  document.getElementById('incoming').style.display = 'none';
  currentCall = null;
}

// â”€â”€ Video Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addRemoteVideo(peerId, stream) {
  if (remoteStreams.has(peerId)) return;
  const tile = document.createElement('div');
  tile.className = 'video-tile main-video';
  tile.id = `tile-${peerId}`;
  const vid = document.createElement('video');
  vid.autoplay = vid.playsinline = true;
  vid.srcObject = stream;
  tile.appendChild(vid);
  const av = document.createElement('div');
  av.className = 'avatar-placeholder';
  av.id = `av-${peerId}`;
  av.innerHTML = `<div class="avatar-circle">${(remoteNames.get(peerId)?.[0]||'?').toUpperCase()}</div>`;
  tile.appendChild(av);
  videoArea.insertBefore(tile, document.getElementById('local-tile'));
  remoteStreams.set(peerId, stream);
  remoteCameras.set(peerId, true);
  updateLayout();
}

function removeRemoteVideo(pid) {
  document.getElementById(`tile-${pid}`)?.remove();
  remoteStreams.delete(pid);
  remoteCameras.delete(pid);
  remoteNames.delete(pid);
  updateLayout();
}

function updateVideoTile(pid = null) {
  if (pid) {
    const vid = document.querySelector(`#tile-${pid} video`);
    const av = document.getElementById(`av-${pid}`);
    if (vid && av) {
      const on = remoteCameras.get(pid);
      vid.style.display = on ? 'block' : 'none';
      av.style.display = on ? 'none' : 'flex';
    }
  } else {
    const hasVid = localStream?.getVideoTracks()[0]?.enabled ?? false;
    localVid.style.display = isCameraOn && hasVid ? 'block' : 'none';
    document.getElementById('local-avatar').style.display = isCameraOn && hasVid ? 'none' : 'flex';
  }
}

function updateLayout() {
  const count = remoteStreams.size;
  videoArea.classList.toggle('side-by-side', count === 1);
}

function updateLocalAvatar() {
  localLetter.textContent = myName.charAt(0).toUpperCase() || '?';
}

function updateRemoteAvatar(pid) {
  const circle = document.querySelector(`#av-${pid} .avatar-circle`);
  if (circle) circle.textContent = (remoteNames.get(pid)?.charAt(0) || '?').toUpperCase();
}

// â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleCamera() {
  if (!localStream) return;
  isCameraOn = !isCameraOn;
  localStream.getVideoTracks()[0].enabled = isCameraOn;
  updateVideoTile();
  dataConns.forEach(c => c.send({type:'camera', on:isCameraOn}));
  document.getElementById('camBtn').classList.toggle('cam-on', isCameraOn);
}

function toggleMute() {
  if (localStream) localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
  document.getElementById('muteBtn').classList.toggle('mute-on');
}

function hangUpAll() {
  dataConns.forEach(c => c.close());
  remoteStreams.forEach((_,p) => removeRemoteVideo(p));
  dataConns.clear();
  groupMembers.clear();
  groupCode = null;
  isGroupHost = false;
  updateGroupDisplay();
  if (localStream) {
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }
  localVid.srcObject = null;
}

// â”€â”€ Groups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createGroup() {
  if (groupCode) return;
  groupCode = Math.random().toString(36).slice(2,8).toUpperCase();
  isGroupHost = true;
  groupMembers.set(peer.id, myName);
  updateGroupDisplay();
}

function joinGroup() {
  const hostId = document.getElementById('groupHostId').value.trim();
  const code = document.getElementById('groupCodeInput').value.trim().toUpperCase();
  if (!hostId || !code) return;
  startCallToHost(hostId, code);
}

async function startCallToHost(target, code) {
  if (!localStream) await startLocalMedia();
  const call = peer.call(target, localStream, {metadata:{name:myName}});
  setupCall(call);
  const conn = peer.connect(target);
  conn.on('open', () => {
    sendMyInfo(conn);
    conn.send({type: 'groupJoinRequest', code});
  });
  setupDataConnection(conn);
}

function connectToGroupMembers(members) {
  members.forEach(m => {
    if (dataConns.has(m.id) || m.id === peer.id) return;
    const call = peer.call(m.id, localStream, {metadata:{name:myName}});
    setupCall(call);
    const conn = peer.connect(m.id);
    setupDataConnection(conn);
  });
}

function broadcastToGroup(msg, exclude = null) {
  dataConns.forEach((conn, pid) => {
    if (pid !== exclude) conn.send(msg);
  });
}

function updateGroupDisplay() {
  const el = document.getElementById('groupStatus');
  if (!groupCode) {
    el.innerHTML = '';
    return;
  }
  let txt = `Group: <strong>${groupCode}</strong>${isGroupHost ? ' (host)' : ''}<br>Members:<br>`;
  groupMembers.forEach((name, id) => {
    txt += `â€¢ ${name} (${id.slice(0,8)}${id===peer.id?' - you':''})<br>`;
  });
  el.innerHTML = txt;
}

function saveName() {
  myName = document.getElementById('username').value.trim() || 'Player';
  localStorage.setItem('vcName', myName);
  updateLocalAvatar();
  dataConns.forEach(c => c.send({type:'name', name:myName}));
}

// Start
const localVid = document.getElementById('local-video');
const videoArea = document.getElementById('video-area');
const localLetter = document.getElementById('local-letter');
initPeer();
updateLocalAvatar();
</script>
</body>
</html>
